import{j as i,c as j,R as y,P as X}from"./index-e4d0ea14.js";import{b as Y}from"./context-cac9b731.js";import{u as Q,a as K}from"./usePublicFile-3fac263c.js";import{r as d,a as H}from"./react-5284b0bf.js";import{u as O}from"./react-query-805b988f.js";import{b as V,L as C}from"./react-router-dom-d629d609.js";import"./useAppConfigQuery-906aaf21.js";function G(e,t){const s=d.useRef(!0);d.useEffect(()=>{if(s.current){s.current=!1;return}return e()},t)}function J(){const[e,t]=d.useState({first:0,second:1}),[s,a]=d.useState(!0);return d.useEffect(()=>{const n=setInterval(()=>{a(o=>!o)},5e3);return()=>clearInterval(n)},[]),G(()=>{const n=setTimeout(()=>{t(({first:o,second:r})=>s&&o>r?{first:o,second:r+2}:!s&&o<r?{first:o+2,second:r}:{first:o,second:r})},2e3);return()=>clearTimeout(n)},[s]),{firstIdx:e.first,secondIdx:e.second,showingFirst:s}}var W=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","#","$","%","*","+",",","-",".",":",";","=","?","@","[","]","^","_","{","|","}","~"],p=e=>{let t=0;for(let s=0;s<e.length;s++){let a=e[s],n=W.indexOf(a);t=t*83+n}return t},k=e=>{let t=e/255;return t<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)},I=e=>{let t=Math.max(0,Math.min(1,e));return t<=.0031308?Math.trunc(t*12.92*255+.5):Math.trunc((1.055*Math.pow(t,.4166666666666667)-.055)*255+.5)},Z=e=>e<0?-1:1,M=(e,t)=>Z(e)*Math.pow(Math.abs(e),t),L=class extends Error{constructor(e){super(e),this.name="ValidationError",this.message=e}},ee=e=>{if(!e||e.length<6)throw new L("The blurhash string must be at least 6 characters");let t=p(e[0]),s=Math.floor(t/9)+1,a=t%9+1;if(e.length!==4+2*a*s)throw new L(`blurhash length mismatch: length is ${e.length} but it should be ${4+2*a*s}`)},te=e=>{let t=e>>16,s=e>>8&255,a=e&255;return[k(t),k(s),k(a)]},se=(e,t)=>{let s=Math.floor(e/361),a=Math.floor(e/19)%19,n=e%19;return[M((s-9)/9,2)*t,M((a-9)/9,2)*t,M((n-9)/9,2)*t]},ae=(e,t,s,a)=>{ee(e),a=a|1;let n=p(e[0]),o=Math.floor(n/9)+1,r=n%9+1,c=(p(e[1])+1)/166,l=new Array(r*o);for(let h=0;h<l.length;h++)if(h===0){let m=p(e.substring(2,6));l[h]=te(m)}else{let m=p(e.substring(4+h*2,6+h*2));l[h]=se(m,c*a)}let u=t*4,g=new Uint8ClampedArray(u*s);for(let h=0;h<s;h++)for(let m=0;m<t;m++){let E=0,R=0,S=0;for(let f=0;f<o;f++)for(let b=0;b<r;b++){let w=Math.cos(Math.PI*m*b/t)*Math.cos(Math.PI*h*f/s),x=l[b+f*r];E+=x[0]*w,R+=x[1]*w,S+=x[2]*w}let q=I(E),z=I(R),B=I(S);g[4*m+0+h*u]=q,g[4*m+1+h*u]=z,g[4*m+2+h*u]=B,g[4*m+3+h*u]=255}return g},re=ae,ie=Object.defineProperty,ne=Object.defineProperties,oe=Object.getOwnPropertyDescriptors,v=Object.getOwnPropertySymbols,D=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable,U=(e,t,s)=>t in e?ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,N=(e,t)=>{for(var s in t||(t={}))D.call(t,s)&&U(e,s,t[s]);if(v)for(var s of v(t))F.call(t,s)&&U(e,s,t[s]);return e},P=(e,t)=>ne(e,oe(t)),T=(e,t)=>{var s={};for(var a in e)D.call(e,a)&&t.indexOf(a)<0&&(s[a]=e[a]);if(e!=null&&v)for(var a of v(e))t.indexOf(a)<0&&F.call(e,a)&&(s[a]=e[a]);return s},_=class extends d.PureComponent{constructor(){super(...arguments),this.canvas=null,this.handleRef=e=>{this.canvas=e,this.draw()},this.draw=()=>{let{hash:e,height:t,punch:s,width:a}=this.props;if(this.canvas){let n=re(e,a,t,s),o=this.canvas.getContext("2d"),r=o.createImageData(a,t);r.data.set(n),o.putImageData(r,0,0)}}}componentDidUpdate(){this.draw()}render(){let e=this.props,{hash:t,height:s,width:a}=e,n=T(e,["hash","height","width"]);return d.createElement("canvas",P(N({},n),{height:s,width:a,ref:this.handleRef}))}};_.defaultProps={height:128,width:128};var le={position:"absolute",top:0,bottom:0,left:0,right:0,width:"100%",height:"100%"},he=class extends d.PureComponent{componentDidUpdate(){if(this.props.resolutionX<=0)throw new Error("resolutionX must be larger than zero");if(this.props.resolutionY<=0)throw new Error("resolutionY must be larger than zero")}render(){let e=this.props,{hash:t,height:s,width:a,punch:n,resolutionX:o,resolutionY:r,style:c}=e,l=T(e,["hash","height","width","punch","resolutionX","resolutionY","style"]);return d.createElement("div",P(N({},l),{style:P(N({display:"inline-block",height:s,width:a},c),{position:"relative"})}),d.createElement(_,{hash:t,height:r,width:o,punch:n,style:le}))}};he.defaultProps={height:128,width:128,resolutionX:32,resolutionY:32};function ce({blurhash:e,src:t,style:s,className:a,...n}){const[o,r]=d.useState(!1),c=Q({path:t,select:u=>u,cacheTime:1e3*60*30,staleTime:1/0});let l="";if(c.isSuccess){const u=new Blob([c.data],{type:"image/jpg"});l=URL.createObjectURL(u)}return i.jsxs("div",{className:`loading-image__container ${a}`,style:{...s,aspectRatio:e.width/e.height},children:[i.jsx(_,{...n,className:`loading-image__canvas${c.isSuccess&&o?" loading-image__hidden":""}`,hash:e.hash,height:e.height,width:e.width}),c.isSuccess?i.jsx("img",{...n,className:"loading-image__image",loading:"lazy",src:l,alt:"CoverImage",onLoad:()=>{requestAnimationFrame(()=>{r(!0)}),URL.revokeObjectURL(l)}}):null]})}function A({book:e,className:t}){var o;const s=V(),a=O({queryKey:[e.id,"authors"],queryFn:async()=>await e.getAuthors()}),n=O({queryKey:[e.id,"series"],queryFn:async()=>await e.getSeries()});return i.jsxs("div",{className:`book-details__container ${t}`,children:[i.jsx("div",{className:"book-details__cover-container",children:i.jsx(ce,{className:"book-details__cover",blurhash:e.blurhash,src:Y(e.id),id:"book-details__book-cover"})}),i.jsxs("div",{className:"book-details__info-container",children:[i.jsx("div",{className:"book-details__title",children:e.title}),i.jsx("div",{className:"book-details__author",children:a.isSuccess?a.data.map((r,c)=>i.jsxs(H.Fragment,{children:[c>0&&", ",i.jsx(C,{to:j({path:y.AUTHOR,params:{authorId:r.id}}),children:r.name})]},c)):null}),e.isPartOfASeries()&&n.isSuccess?i.jsx("div",{className:"book-details__series",children:i.jsx(C,{to:j({path:y.SERIES,params:{seriesId:e.seriesId}}),children:`${(o=n.data)==null?void 0:o.title} #${e.positionInSeries}`})}):null,i.jsx("div",{className:"book-details__genre-list",children:e.genre.map(r=>i.jsx("div",{className:"book-details__genre",children:r},r))})]}),i.jsxs("div",{className:"book-details__button-container",children:[i.jsx("button",{className:"book-details__button",onClick:()=>{s(j({path:y.READER,params:{bookId:e.id}}))},children:"Read"}),i.jsx("button",{className:"book-details__button",children:"Info"})]}),i.jsx("div",{className:"book-details__background",children:i.jsx(_,{...e.blurhash})})]})}const $=(e,t)=>(e%t+t)%t;function ue({bookList:e}){const t=d.useMemo(()=>{const r=Array.from(e.keys());for(let l=r.length-1;l>0;l--){const u=Math.floor(Math.random()*(l+1));[r[l],r[u]]=[r[u],r[l]]}const c=new Array;for(let l=0;l<10&&l<r.length;l++)c.push(e[l]);return c},[e]),{firstIdx:s,secondIdx:a,showingFirst:n}=J();return i.jsxs("div",{className:"book-list__container",children:[i.jsx(A,{book:t[$(s,t.length)],className:n?"book-list__showing":"book-list__hidden"}),i.jsx(A,{book:t[$(a,t.length)],className:n?"book-list__hidden":"book-list__showing"})]})}function _e(){const e=K({queryKey:["all-book-list"],dbQuery:async t=>await t.books.toArray()});return i.jsx("div",{className:"home-page",children:e.isSuccess?i.jsx(ue,{bookList:e.data}):i.jsx(X,{})})}export{_e as default};
